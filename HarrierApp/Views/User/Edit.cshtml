@model HarrierApp.Models.User

@{
    ViewBag.Title = "Edit User";
}

<h2>Edit User</h2>
@using(Html.BeginForm("Edit" , "User" , FormMethod.Post , new { id = "userForm" }))
{
    @Html.AntiForgeryToken()

    <style>
        .validation-error {
            color: red;
        }

        .form-group {
            margin-bottom: 15px;
        }
    </style>
    <div class="form-group">
        @Html.LabelFor(model => model.Name)
        @Html.TextBoxFor(model => model.Name , new { @class = "form-control" })
        <span class="validation-error" id="name"></span>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Email)
        @Html.TextBoxFor(model => model.Email , new { @class = "form-control" })
        <span class="validation-error" id="email"></span>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Mobile)
        @Html.TextBoxFor(model => model.Mobile , new { @class = "form-control" })
        <span class="validation-error" id="mobile"></span>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Skills)
        <div>
            @foreach(var skill in new[] { "C" , "Cpp" , "Java" , "Html" , "Css" , "CSharp" , "JQuery" })
            {
                <label class="checkbox-inline">
                    @{
                        var isChecked = Model.Skills != null && Model.Skills.Contains(skill);
                    }
                    @Html.CheckBox("Skills" , isChecked , new { value = skill }) @skill
                </label>
            }
            <span class="validation-error" id="skill"></span>
        </div>
    </div>


    <div class="form-group">
        @Html.LabelFor(model => model.Role)
        <div>
            @foreach(var role in new[] { "User" , "Admin" , "SuperAdmin" })
            {
                <label class="radio-inline">
                    @Html.RadioButtonFor(model => model.Role , role) @role
                </label>
            }
            <span class="validation-error" id="role"></span>
        </div>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Status)
        <div>
            @foreach(var status in new[] { "Active" , "Inactive" })
            {
                <label class="radio-inline">
                    @Html.RadioButtonFor(model => model.Status , status) @status
                </label>
            }
            <span class="validation-error" id="status"></span>
        </div>
    </div>

    <div class="form-group">
        <input type="hidden" id="FilteredSkills" name="FilteredSkills" />
    </div>

    <div class="form-group">
        <button type="button" class="btn btn-primary">Update</button>
        @Html.ActionLink("Back to List" , "Index")
    </div>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
    $(document).ready(function () {
        $("button[type='button']").click(function () {
             console.log('Submitting form...');
            validateForm();
        });

        function validateForm() {
             console.log('Validating...');
            // Reset previous error messages
            $(".validation-error").text("");

            // Validate name
            var name = $.trim($("#Name").val());
            if (!name) {
                $("#name").text("Please enter a name.");
                return;
            }
            if (!/^[a-zA-Z]+$/.test(name)) {
                $("#name").text("Please enter a valid text for the name (only letters allowed).");
                return;
            }

            // Validate email
            var email = $.trim($("#Email").val());
            if (!email) {
                $("#email").text("Please enter an email address.");
                return;
            }
            var emailRegex = /^[^\s]+[^\s]+\.[^\s]+$/;
            if (!emailRegex.test(email)) {
                $("#email").text("Please enter a valid email address.");
                return;
            }

            // Validate number
            var number = $.trim($("#Mobile").val());
            if (!number) {
                $("#mobile").text("Please enter a mobile number.");
                return;
            }
            if (!$.isNumeric(number) || number.length !== 10) {
                $("#mobile").text("Please enter a valid 10-digit mobile number.");
                return;
            }

            // Validate skills (at least 2 should be selected)
            var checkboxes = document.getElementsByName('Skills');
            var selectedSkills = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (selectedSkills.length < 2) {
                $("#skill").text("Please select at least 2 skills.");
                return;
            }

            // Validate role (at least one should be selected)
            var selectedRole = $("input[name='Role']:checked").val();
            if (!selectedRole) {
                $("#role").text("Please select a role.");
                return;
            }

            // Validate status (at least one should be selected)
            var selectedStatus = $("input[name='Status']:checked").val();
            if (!selectedStatus) {
                $("#status").text("Please select a status.");
                return;
            }
            // If all validations pass, submit the form
            submitForm();
        }

        function submitForm() {
             console.log('Submitting DATA');
            // Get all checkboxes with the name 'Skills'
            var checkboxes = document.getElementsByName('Skills');

            // Filter out only checked checkboxes
            var selectedSkills = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            // Set the filtered skills as the value of the hidden input
            document.getElementById('FilteredSkills').value = selectedSkills.join(',');

            // Submit the form using AJAX
            $.ajax({
                url: '@Url.Action("Edit", "User")', // Replace with your actual controller action
                type: 'POST',
                data: $("#userForm").serialize(),
                success: function (result) {
                    // Handle the success response
                    console.log(result);
                      // Redirect to the "Index" action on success
                   window.location.href = '@Url.Action("Index", "User")';

                },
                error: function (error) {
                    // Handle the error response
                    console.log(error);
                }
            });
        }
    });
    </script>
}
